// Prisma schema for Cure & Care Dispatch System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries   Delivery[]
  pettyCash    PettyCash[]
  
  @@map("users")
}

model Delivery {
  id            String         @id @default(uuid())
  invoiceNumber String         @unique
  customerName  String
  customerPhone String?
  address       String
  status        DeliveryStatus @default(PENDING)
  
  latitude      Float?
  longitude     Float?
  accuracy      Float?
  altitude      Float?
  altitudeAccuracy Float?
  heading       Float?
  speed         Float?
  gpsTimestamp  BigInt?
  isMockLocation Boolean       @default(false)
  qualityScore  Int?
  gpsWarnings   String?
  
  deliveredAt   DateTime?
  proofImage    String?
  signature     String?
  customerNotes String?
  
  failureReason      String?
  failureNotes       String?
  failurePhotoUrls   String?
  failedAt           DateTime?
  
  driverId      String?
  driver        User?          @relation(fields: [driverId], references: [id])
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("deliveries")
  @@index([driverId])
  @@index([status])
}

model PettyCash {
  id          String         @id @default(uuid())
  amount      Float
  category    CashCategory
  description String
  status      ApprovalStatus @default(PENDING)
  
  latitude    Float?
  longitude   Float?
  timestamp   DateTime
  receiptUrl  String?
  
  driverId    String
  driver      User           @relation(fields: [driverId], references: [id])
  
  approvedAt  DateTime?
  rejectedAt  DateTime?
  notes       String?
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@map("petty_cash")
  @@index([driverId])
  @@index([status])
}

enum Role {
  ADMIN
  DRIVER
  MANAGER
}

enum DeliveryStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  FAILED
  CANCELLED
}

enum CashCategory {
  PETROL
  TOLL
  PARKING
  MAINTENANCE
  OTHER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// GPS Tracking
model DriverLocation {
  id         String   @id @default(uuid())
  driverId   String
  latitude   Float
  longitude  Float
  accuracy   Float?
  altitude   Float?
  altitudeAccuracy Float?
  speed      Float?
  heading    Float?
  gpsTimestamp BigInt?
  isMockLocation Boolean @default(false)
  qualityScore Int?
  timestamp  DateTime @default(now())
  
  @@map("driver_locations")
  @@index([driverId])
  @@index([timestamp])
}

// Delivery Tracking History
model DeliveryTracking {
  id          String   @id @default(uuid())
  deliveryId  String
  status      String
  latitude    Float?
  longitude   Float?
  notes       String?
  timestamp   DateTime @default(now())
  
  @@map("delivery_tracking")
  @@index([deliveryId])
  @@index([timestamp])
}

// Audit Log
model AuditLog {
  id          String   @id @default(uuid())
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity      String   // DELIVERY, USER, PETTY_CASH, etc.
  entityId    String?
  userId      String
  userName    String
  userRole    String
  changes     String?  // JSON string of before/after changes
  ipAddress   String?
  userAgent   String?
  metadata    String?  // Additional context as JSON
  timestamp   DateTime @default(now())
  
  @@map("audit_logs")
  @@index([userId])
  @@index([entity])
  @@index([action])
  @@index([timestamp])
}

// WhatsApp Notifications
model Notification {
  id         String   @id @default(uuid())
  recipient  String
  type       String
  message    String
  deliveryId String?
  status     String   @default("pending")
  sentAt     DateTime?
  error      String?
  createdAt  DateTime @default(now())
  
  @@map("notifications")
  @@index([recipient])
  @@index([status])
}
